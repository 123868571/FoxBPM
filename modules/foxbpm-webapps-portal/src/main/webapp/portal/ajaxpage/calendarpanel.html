<!-- widget grid -->
<section id="widget-grid" class="">

<div class="row">
	<div class="col-sm-12 col-md-12 col-lg-9" style="width:100%">

		<!-- new widget -->
		<div class="jarviswidget jarviswidget-color-blueDark">

			<!-- widget options:
			usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

			data-widget-colorbutton="false"
			data-widget-editbutton="false"
			data-widget-togglebutton="false"
			data-widget-deletebutton="false"
			data-widget-fullscreenbutton="false"
			data-widget-custombutton="false"
			data-widget-collapsed="true"
			data-widget-sortable="false"

			-->
			<header>
				<span class="widget-icon"> <i class="fa fa-calendar"></i> </span>
				<h2>日历面板 </h2>
				<div class="widget-toolbar">
					<!-- add: non-hidden - to disable auto hide -->
					<div class="btn-group">
						<button id="select_priority" class="btn dropdown-toggle btn-xs btn-default" data-toggle="dropdown">
							优先级<i class="fa fa-caret-down"></i>
						</button>
						<ul class="dropdown-menu js-status-update pull-right">
							<li>
								<a href="javascript:void(0);" id="priority_all">所有</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="priority_high">高</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="priority_mid">中</a>
							</li> 
							<li>
								<a href="javascript:void(0);" id="priority_low">低</a>
							</li> 
						</ul>
					</div> &nbsp;&nbsp;&nbsp;
					<div class="btn-group">
						<button id="select_time" class="btn dropdown-toggle btn-xs btn-default" data-toggle="dropdown">
							任务创建<i class="fa fa-caret-down"></i>
						</button>
						<ul class="dropdown-menu js-status-update pull-right">
							<li>
								<a href="javascript:void(0);" id="task_createtime">任务创建</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="task_duration">任务期限</a>
							</li> 
						</ul>
					</div> &nbsp;&nbsp;&nbsp;
					<div class="btn-group">
						<button id="select_view" class="btn dropdown-toggle btn-xs btn-default" data-toggle="dropdown">
							周-日程表<i class="fa fa-caret-down"></i>
						</button>
						<ul class="dropdown-menu js-status-update pull-right">
							<li>
								<a href="javascript:void(0);" id="mt">月 视图</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="basicWeek">周 视图</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="basicDay">日 视图</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="ag">周-日程表</a>
							</li>
							<li>
								<a href="javascript:void(0);" id="td">日-日程表</a>
							</li>
						</ul>
					</div>
				</div>
			</header>

			<!-- widget div-->
			<div>

				<div class="widget-body no-padding"> 
							<div class="btn-group" style="padding-top:5px;padding-left:5px">
								<a href="javascript:void(0)" class="btn btn-default btn-xs" id="btn-prev"><i class="fa fa-chevron-left"></i></a>
								<a href="javascript:void(0)" class="btn btn-default btn-xs" id="btn-next"><i class="fa fa-chevron-right"></i></a>
							</div> 
					<div id="calendar" style="padding-top:6px"></div>

					<!-- end content -->
				</div>

			</div>
			<!-- end widget div -->
		</div>
		<!-- end widget -->

	</div>

</div>

<div class="modal fade " id="remoteModal" tabindex="-1" role="dialog" aria-labelledby="remoteModalLabel" aria-hidden="true">  
    <div class="modal-dialog" style="width:800px">  
      	<iframe id="contentFrame" class="col-sm-10 col-md-12 col-lg-12" style="border:0px; height:500px;"></iframe>
    </div>  
</div>   
<div id="eventInfoTip" >
	<div id="eventInfoTip2" class="SmallBox animated fadeInRight fast" style="top:500px;left:500px;background-color:#4C4F53">
		<div>
			<span id="eventInfoTipCreateTime"></span>
			<span id="eventInfoTipTitle"></span>
			<span id="eventInfoTipPriority"></span>
		</div>
	</div>
</div>
</section>
<link href='../css/fullcalendar.min.css' rel='stylesheet' /> 
<link href='../css/fullcalendar.print.css' rel='stylesheet' media='print' />

<script src="../portal/js/foxbpm/common.js"></script>
<!-- end row --> 
<script type="text/javascript">
	var taskPriority="";
	$("#eventInfoTip").hide(); 
	function showFormByUrl(formUrl){
		$("#contentFrame").attr("src",formUrl);
		$('#remoteModal').modal({backdrop:"static"});
		//$('#calendar').fullCalendar('refetchEvents');
		//$('#calendar').fullCalendar( 'removeEvents', [formUrl ] );
	}
	$('#remoteModal').on('hide.bs.modal', function () {
			$('#calendar').fullCalendar('refetchEvents');
	});
	 
	pageSetUp();
	var showWeekend = true;
	var pagefunction = function() {
		
		// full calendar
		 
	    var hdr = {
	        left:  'prev,next today',
	        center: 'title',
	        right:'month,agendaWeek,agendaDay'
	    }; 
	    /* initialize the calendar
		 -----------------------------------------------------------------*/
	    $('#calendar').fullCalendar({
	    	lazyFetching:false,
	    	aspectRatio:2,
	    	allDaySlot:false,
	    	weekends:showWeekend,
	    	slotEventOverlap:false,
	    	lang:'zh-cn',
	    	defaultView: 'agendaWeek',
	        header: hdr,
	        editable: false,
	        droppable: false, // this allows things to be dropped onto the calendar !!!
	        viewRender:function(a,b){
	        	$(".fc-toolbar").css("margin-bottom","0px");
	        	 
			},
			eventMouseover:function(event, jsEvent, view ) {
				$("#eventInfoTipCreateTime").html("创        &nbsp;&nbsp; 建:  "+event.start.format("YYYY-MM-DD HH:mm:ss"));
				$("#eventInfoTipTitle").html("主      &nbsp;&nbsp; 题:  "+event.title);
				
				var priority = "";
				if(event.className == "event,bg-color-red"){
					priority = "高";
				}else if(event.className == "event,bg-color-greenLight"){
					priority = "中";
				}else if(event.className == "event,bg-color-darken"){
					priority = "低";
				}
				
				$("#eventInfoTipPriority").html("优先级:  "+priority);
				
				$("#eventInfoTip").css("display", "block"); 
				$("#eventInfoTip").css("z-index", "1000000"); 
				$("#eventInfoTip").css("position", ""); 
				if(document.getElementById("jarviswidget-fullscreen-mode")){
					$("#eventInfoTip").css("position", "fixed"); 
				}
				
				var tipLeft = jsEvent.clientX-200;
				if(jsEvent.clientX+500>document.body.clientWidth){
					tipLeft = jsEvent.clientX-(700-(document.body.clientWidth-jsEvent.clientX))
				}
		      	$("#eventInfoTip2").css("top",jsEvent.clientY-70+document.body.scrollTop);  
		       	$("#eventInfoTip2").css("left",tipLeft);  
		       	$("#eventInfoTip").show();
				
			},
			eventMouseout:function( calEvent, jsEvent, view ) {
				$("#eventInfoTip").hide(); 
			},
			eventClick:function( event, jsEvent, view ) {
				if(document.getElementById("jarviswidget-fullscreen-mode")){
					$("#remoteModal").css("z-index", "1000000"); 
					$("#remoteModal").css("position", "fixed"); 
				}
				showFormByUrl(event.id);
			},
	
	        events: function(start, end, timezone, callback) {
		    	$.ajax({
		            url: _serviceTaskUrl,
		            dataType: 'json',
		            data: {
		            	createTimeB: start.format(),
		            	createTimeE: end.format()
		            },
		            success: function(doc) {
		                var events = []; 
		                var taskColor;
		                for(var i=0;i<doc.data.length;i++){ 
		                	
		                	//判断是否选择了优先级
		                	if(taskPriority == ""){
		                		if(doc.data[i].priority == "50"){
			                		taskColor = ["event", "bg-color-greenLight"];
			                	}else if(doc.data[i].priority == "0"){
			                		taskColor = ["event", "bg-color-darken"];
			                	}else if(doc.data[i].priority == "100"){
			                		taskColor = ["event", "bg-color-red"];
			                	}
			                	var create_time = new Date(doc.data[i].createTime);
			                	var due_time;
			                	if(doc.data[i].dueDate == null){
			                		due_time = null;
			                	}else{
			                		due_time = new Date(doc.data[i].dueDate);
			                	}
			                	events.push({
			                        title: doc.data[i].subject,
			                        start: create_time, 
									end:due_time,
			                        className: taskColor,
			                        id:_formUrl+"?dataId="+doc.data[i].bizKey+"&taskId="+doc.data[i].id+"&processInstanceId="+doc.data[i].processInstanceId,
			                    });
		                	}else if(taskPriority == doc.data[i].priority){
		                		if(doc.data[i].priority == "50"){
			                		taskColor = ["event", "bg-color-greenLight"];
			                	}else if(doc.data[i].priority == "0"){
			                		taskColor = ["event", "bg-color-darken"];
			                	}else if(doc.data[i].priority == "100"){
			                		taskColor = ["event", "bg-color-red"];
			                	}
			                	var create_time = new Date(doc.data[i].createTime);
			                	var due_time;
			                	if(doc.data[i].dueDate == null){
			                		due_time = null;
			                	}else{
			                		due_time = new Date(doc.data[i].dueDate);
			                	}
			                	events.push({
			                        title: doc.data[i].subject,
			                        start: create_time, 
									end:due_time,
			                        className: taskColor,
			                        id:_formUrl+"?dataId="+doc.data[i].bizKey+"&taskId="+doc.data[i].id+"&processInstanceId="+doc.data[i].processInstanceId,
			                    });
		                	}
		                	
		                }
		                callback(events);
		            }
		        });
		         
		    },
	
	        eventRender: function (event, element, icon) {
	        },
	
	        windowResize: function (event, ui) {
	            $('#calendar').fullCalendar('render');
	        }
	    });
	 
	    $('.fc-right, .fc-left').hide();
	
		$('#btn-prev').click(function () {
		    //$('.fc-prev-button').click();
		    $('#calendar').fullCalendar('prev');
		    var moment = $('#calendar').fullCalendar('getDate');
		    //alert("The current date of the calendar is " + moment.format());
		    
		    var view = $('#calendar').fullCalendar('getView');
		    //alert("The view's title is " + view.title);
		    
		    //alert("The view's name is " + view.name);
		    
		    //alert("The view's start is " + view.start.format());
		    // alert("The view's end is " + view.end.format());
		    //alert("The view's intervalStart is " + view.intervalStart.format());
		    // alert("The view's intervalEnd is " + view.intervalEnd.format());
		    
		    return false;
		});
		
		$('#btn-next').click(function () {
		    //$('.fc-next-button').click();
		    $('#calendar').fullCalendar('next');
		    var moment = $('#calendar').fullCalendar('getDate'); 
		    return false;
		});
		
		$('#calendar-buttons #btn-today').click(function () {
		    $('.fc-button-today').click();
		    return false;
		});
		
		$('#mt').click(function () {
			$('#select_view').html($('#mt').html()+"<i class='fa fa-caret-down'></i>");
		    $('#calendar').fullCalendar('changeView', 'month');
		});
		
		$('#ag').click(function () {
			$('#select_view').html($('#ag').html()+"<i class='fa fa-caret-down'></i>");
		    $('#calendar').fullCalendar('changeView', 'agendaWeek');
		});
		
		$('#td').click(function () {
			$('#select_view').html($('#td').html()+"<i class='fa fa-caret-down'></i>");
		    $('#calendar').fullCalendar('changeView', 'agendaDay');
		});
		
		$('#basicWeek').click(function () {
			$('#select_view').html($('#basicWeek').html()+"<i class='fa fa-caret-down'></i>");
		    $('#calendar').fullCalendar('changeView', 'basicWeek');
		});
		
		$('#basicDay').click(function () {
			$('#select_view').html($('#basicDay').html()+"<i class='fa fa-caret-down'></i>");
		    $('#calendar').fullCalendar('changeView', 'basicDay');
		});
		
		$('#task_createtime').click(function () {
			$('#select_time').html($('#task_createtime').html()+"<i class='fa fa-caret-down'></i>"); 
		});
		$('#task_duration').click(function () {
			$('#select_time').html($('#task_duration').html()+"<i class='fa fa-caret-down'></i>"); 
		});
		
		$('#priority_high').click(function () {
			taskPriority = "100";
			$('#select_priority').html($('#priority_high').html()+"<i class='fa fa-caret-down'></i>"); 
			$('#calendar').fullCalendar('refetchEvents');
		});
		
		$('#priority_mid').click(function () {
			taskPriority = "50";
			$('#select_priority').html($('#priority_mid').html()+"<i class='fa fa-caret-down'></i>"); 
			$('#calendar').fullCalendar('refetchEvents');
		});
		
		$('#priority_low').click(function () {
			taskPriority = "0";
			$('#select_priority').html($('#priority_low').html()+"<i class='fa fa-caret-down'></i>"); 
			$('#calendar').fullCalendar('refetchEvents');
		});
		$('#priority_all').click(function () {
			taskPriority = "";
			$('#select_priority').html($('#priority_all').html()+"<i class='fa fa-caret-down'></i>"); 
			$('#calendar').fullCalendar('refetchEvents');
		});
		
		
		
	};
	
	// end pagefunction
	
	// loadscript and run pagefunction 
	 
	loadScript("../js/plugin/fullcalendar/moment.min.js", function(){
		loadScript("../js/plugin/fullcalendar/fullcalendar.min.js",function(){
			loadScript("../js/plugin/fullcalendar/lang-all.js",pagefunction)
		});
	});

</script>